import os
import json
from datetime import datetime

TODO_FILE = "todo_list.json"
PRIORITY_ORDER = {"ë†’ìŒ": 1, "ì¤‘ê°„": 2, "ë‚®ìŒ": 3}

def load_tasks():
    if os.path.exists(TODO_FILE):
        with open(TODO_FILE, "r", encoding="utf-8") as f:
            try:
                return json.load(f)
            except json.JSONDecodeError:
                print("âš ï¸ ì €ì¥ëœ íŒŒì¼ì´ ì†ìƒë˜ì–´ ìƒˆ ëª©ë¡ìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.")
                return []
    return []

def save_tasks(tasks):
    with open(TODO_FILE, "w", encoding="utf-8") as f:
        json.dump(tasks, f, indent=4, ensure_ascii=False)

def show_tasks(tasks):
    if not tasks:
        print("í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
        return []

    sorted_tasks = sorted(tasks, key=lambda x: PRIORITY_ORDER.get(x.get("priority", "ë‚®ìŒ"), 3))
    for i, task in enumerate(sorted_tasks, 1):
        status = "âœ…" if task.get("done", False) else "âŒ"
        print(f"{i}. {status} {task.get('title', '')} (ìƒì„±ì¼: {task.get('created_at', '')}, ë§ˆê°ê¸°í•œ: {task.get('deadline', 'ì—†ìŒ')}, ìš°ì„ ìˆœìœ„: {task.get('priority', 'ë‚®ìŒ')})")
    return sorted_tasks

def input_priority():
    while True:
        p = input("ìš°ì„ ìˆœìœ„ë¥¼ ì…ë ¥í•˜ì„¸ìš” [ë†’ìŒ/ì¤‘ê°„/ë‚®ìŒ]: ").strip()
        if p in PRIORITY_ORDER:
            return p
        else:
            print("ì˜¬ë°”ë¥¸ ìš°ì„ ìˆœìœ„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")

def input_deadline():
    deadline = input("ë§ˆê°ê¸°í•œ (ì˜ˆ: 2025-06-20, ì—†ìœ¼ë©´ ì—”í„°): ").strip()
    if not deadline:
        return "ì—†ìŒ"
    try:
        datetime.strptime(deadline, "%Y-%m-%d")
        return deadline
    except ValueError:
        print("ë‚ ì§œ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. ë§ˆê°ê¸°í•œì„ 'ì—†ìŒ'ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.")
        return "ì—†ìŒ"

def add_task(tasks):
    title = input("í•  ì¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”: ").strip()
    created_at = datetime.now().strftime("%Y-%m-%d")
    deadline = input_deadline()
    priority = input_priority()
    tasks.append({
        "title": title,
        "created_at": created_at,
        "deadline": deadline,
        "priority": priority,
        "done": False
    })
    print("âœ… í•  ì¼ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.")

def mark_done(tasks):
    if not tasks:
        print("ì²˜ë¦¬í•  í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
        return

    sorted_tasks = show_tasks(tasks)
    try:
        num = int(input("ì™„ë£Œí•œ í•  ì¼ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”: ")) - 1
        if 0 <= num < len(sorted_tasks):
            task_to_mark = sorted_tasks[num]
            index = tasks.index(task_to_mark)
            tasks[index]["done"] = True
            print("âœ… ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.")
        else:
            print("ì˜ëª»ëœ ë²ˆí˜¸ì…ë‹ˆë‹¤.")
    except ValueError:
        print("ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.")

def delete_task(tasks):
    if not tasks:
        print("ì‚­ì œí•  í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
        return

    sorted_tasks = show_tasks(tasks)
    try:
        num = int(input("ì‚­ì œí•  í•  ì¼ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”: ")) - 1
        if 0 <= num < len(sorted_tasks):
            task_to_delete = sorted_tasks[num]
            tasks.remove(task_to_delete)
            print("ğŸ—‘ï¸ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.")
        else:
            print("ì˜ëª»ëœ ë²ˆí˜¸ì…ë‹ˆë‹¤.")
    except ValueError:
        print("ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.")

def edit_task(tasks):
    if not tasks:
        print("ìˆ˜ì •í•  í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
        return

    sorted_tasks = show_tasks(tasks)
    try:
        num = int(input("ìˆ˜ì •í•  í•  ì¼ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”: ")) - 1
        if 0 <= num < len(sorted_tasks):
            task_to_edit = sorted_tasks[num]
            index = tasks.index(task_to_edit)

            print(f"í˜„ì¬ ì œëª©: {task_to_edit.get('title', '')}")
            new_title = input("ìƒˆ ì œëª© (ì—”í„° ëˆ„ë¥´ë©´ ë³€ê²½ ì•ˆ í•¨): ").strip()
            if new_title:
                tasks[index]['title'] = new_title

            print(f"í˜„ì¬ ë§ˆê°ê¸°í•œ: {task_to_edit.get('deadline', 'ì—†ìŒ')}")
            new_deadline = input("ìƒˆ ë§ˆê°ê¸°í•œ (ì˜ˆ: 2025-06-20, ì—”í„° ì‹œ ë³€ê²½ ì•ˆ í•¨): ").strip()
            if new_deadline:
                try:
                    datetime.strptime(new_deadline, "%Y-%m-%d")
                    tasks[index]['deadline'] = new_deadline
                except ValueError:
                    print("ë‚ ì§œ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. ë³€ê²½í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")

            print(f"í˜„ì¬ ìš°ì„ ìˆœìœ„: {task_to_edit.get('priority', 'ë‚®ìŒ')}")
            new_priority = input("ìƒˆ ìš°ì„ ìˆœìœ„ [ë†’ìŒ/ì¤‘ê°„/ë‚®ìŒ] (ì—”í„° ì‹œ ë³€ê²½ ì•ˆ í•¨): ").strip()
            if new_priority in PRIORITY_ORDER:
                tasks[index]['priority'] = new_priority

            print("âœï¸ ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
        else:
            print("ì˜ëª»ëœ ë²ˆí˜¸ì…ë‹ˆë‹¤.")
    except ValueError:
        print("ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")

def main():
    tasks = load_tasks()
    while True:
        print("\n=== ğŸ“‹ í•  ì¼ ëª©ë¡ ì•± ===")
        print("1. ëª©ë¡ ë³´ê¸°")
        print("2. í•  ì¼ ì¶”ê°€")
        print("3. ì™„ë£Œ ì²˜ë¦¬")
        print("4. ì‚­ì œ")
        print("5. ìˆ˜ì •")
        print("6. ì €ì¥ í›„ ì¢…ë£Œ")

        choice = input("ì„ íƒ: ").strip()
        if choice == "1":
            show_tasks(tasks)
        elif choice == "2":
            add_task(tasks)
        elif choice == "3":
            mark_done(tasks)
        elif choice == "4":
            delete_task(tasks)
        elif choice == "5":
            edit_task(tasks)
        elif choice == "6":
            save_tasks(tasks)
            print("ì €ì¥ í›„ ì¢…ë£Œí•©ë‹ˆë‹¤.")
            break
        else:
            print("ì˜¬ë°”ë¥¸ ë©”ë‰´ ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.")

if __name__ == "__main__":
    main()
